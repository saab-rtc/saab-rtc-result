<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Previous head content remains exactly the same] -->
</head>
<body>
  <!-- [Previous HTML content remains exactly the same until the script] -->

  <script>
    const API = "https://sheetdb.io/api/v1/sh871nkwz39y0";

    function normalizeCNIC(cnic) {
      return cnic.replace(/\D/g, '');
    }

    function formatCNICInput(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 5) value = value.slice(0, 5) + '-' + value.slice(5);
      if (value.length > 13) value = value.slice(0, 13) + '-' + value.slice(13);
      input.value = value.slice(0, 15);
    }

    function formatCNIC(cnic) {
      const cleaned = normalizeCNIC(cnic);
      return cleaned.length === 13
        ? `${cleaned.slice(0, 5)}-${cleaned.slice(5, 12)}-${cleaned.slice(12)}`
        : cnic;
    }

    async function checkResult() {
      const cnicInput = document.getElementById("cnic");
      const cnic = cnicInput.value.trim();
      const cleaned = normalizeCNIC(cnic);
      const resultContainer = document.getElementById("resultContainer");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const resultSummary = document.getElementById("resultSummary");
      
      resultContainer.innerHTML = "";
      resultContainer.style.display = "block";
      loadingSpinner.style.display = "block";
      resultSummary.style.display = "none";

      if (cleaned.length !== 13) {
        resultContainer.innerHTML = `<p class="error-message">Please enter a valid 13-digit CNIC.</p>`;
        cnicInput.focus();
        loadingSpinner.style.display = "none";
        return;
      }

      try {
        console.log("Fetching data from API...");
        const response = await fetch(API, { 
          headers: { 'Cache-Control': 'no-cache' } 
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("API response data:", data);
        
        if (!data || data.length === 0) {
          throw new Error("No data received from API");
        }

        // Find the trainee by CNIC (checking multiple possible field names)
        const trainee = data.find(record => {
          // Check all possible CNIC field names
          const possibleCNICFields = [
            record["CNIC"],
            record["CNIC:"],
            record["CNIC No"],
            record["CNIC Number"],
            record["CNIC_NO"],
            record["CNIC_NUMBER"]
          ];
          
          return possibleCNICFields.some(cnicField => 
            cnicField && normalizeCNIC(cnicField) === cleaned
          );
        });

        console.log("Found trainee record:", trainee);

        if (!trainee) {
          loadingSpinner.style.display = "none";
          resultContainer.innerHTML = `
            <p class="error-message">
              No record found for CNIC: ${formatCNIC(cnic)}
              <br><small>Check that the CNIC matches exactly what's in the database</small>
            </p>
          `;
          return;
        }

        // Display the result
        displayResult(trainee, cleaned);
        
      } catch (err) {
        console.error("Error fetching result:", err);
        loadingSpinner.style.display = "none";
        resultContainer.innerHTML = `
          <p class="error-message">
            Error loading results: ${err.message}
            <button class="retry-btn" onclick="checkResult()">Retry</button>
          </p>
        `;
      }
    }

    function displayResult(trainee, cleanedCNIC) {
      const resultContainer = document.getElementById("resultContainer");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const resultSummary = document.getElementById("resultSummary");

      loadingSpinner.style.display = "none";
      resultSummary.style.display = "block";

      // Get field values with fallbacks
      const getField = (fieldNames, defaultValue = "N/A") => {
        const names = Array.isArray(fieldNames) ? fieldNames : [fieldNames];
        for (const name of names) {
          if (trainee[name] !== undefined && trainee[name] !== "") {
            return trainee[name];
          }
        }
        return defaultValue;
      };

      const resultStatus = getField(["Result", "RESULT", "RESULT STATUS"]);
      const statusIcon = document.querySelector("#resultSummary i");
      const statusText = document.getElementById("statusText");
      
      statusText.textContent = resultStatus;
      statusIcon.className = resultStatus === "Pass" 
        ? "fas fa-check-circle" 
        : "fas fa-times-circle";
      statusIcon.style.color = resultStatus === "Pass" 
        ? "var(--success)" 
        : "var(--error)";

      const subjects = [
        "Legal Knowledge",
        "CrPC & Police Rules",
        "PPW & Forensic Sci",
        "General Knowledge",
        "Investigation",
        "Operation",
        "Security",
        "Intelligence",
        "Module 01 to 20",
        "English Language & Professional Skills",
        "Prade & Drill",
        "Physical & Fitness",
        "Musketry & Firing",
        "Discipline",
        "Viva Voce"
      ];

      let output = `<div id="resultCard" class="result-card">
        <div class="info-grid">
          <p><strong>Roll No:</strong> ${getField(["ROLL / SEAT NO", "Roll No", "Seat No"])}</p>
          <p><strong>Rank & B.No:</strong> ${getField(["RANK & B.No", "Rank", "B.No"])}</p>
          <p><strong>Name:</strong> ${getField(["NAME", "Name"])}</p>
          <p><strong>Father's Name:</strong> ${getField(["FATHER'S NAME", "Father Name"])}</p>
          <p><strong>CNIC:</strong> ${formatCNIC(cleanedCNIC)}</p>
          <p><strong>Arrival Dist/Unit:</strong> ${getField(["ARRIVAL DIST. /UNIT", "Unit"])}</p>
        </div>

        <table>
          <thead>
            <tr>
              <th>Subject</th>
              <th>Marks</th>
            </tr>
          </thead>
          <tbody>`;

      subjects.forEach((subject) => {
        const marks = getField([subject, subject.toUpperCase()]);
        output += `<tr><td>${subject}</td><td>${marks}</td></tr>`;
      });

      output += `</tbody>
        <tfoot>
          <tr><th>Total</th><td>${getField(["Total", "TOTAL"])}</td></tr>
          <tr><th>Percentage</th><td>${getField(["Percentage", "PERCENTAGE"])}%</td></tr>
          <tr><th>Grade</th><td>${getField(["GRADE", "Grade"])}</td></tr>
          <tr><th>Result</th><td>${resultStatus}</td></tr>
        </tfoot>
      </table>
    </div>

    <div class="action-buttons">
      <button class="btn-print" onclick="window.print()" aria-label="Print Result">
        <i class="fas fa-print"></i> Print Result
      </button>
      <button class="btn-pdf" onclick="downloadPDF()" aria-label="Download PDF">
        <i class="fas fa-file-pdf"></i> Download PDF
      </button>
    </div>`;

      resultContainer.innerHTML = output;
    }

    function downloadPDF() {
      const element = document.getElementById("resultCard");
      if (!element) {
        alert("Please load a result first before downloading.");
        return;
      }
      const opt = {
        margin: 0.5,
        filename: `Trainee_Result_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, backgroundColor: '#fff' },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
      const icon = document.querySelector(".theme-toggle i");
      icon.className = document.body.classList.contains("light-mode")
        ? "fas fa-sun"
        : "fas fa-moon";
    }

    // Add Enter key support for search
    document.getElementById("cnic").addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        checkResult();
      }
    });
  </script>
</body>
</html>
